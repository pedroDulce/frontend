<!-- qa-chat-assistant.component.html -->
<div class="chat-widget" [class.collapsed]="isCollapsed" *ngIf="!showMonitoringView">
  <div class="chat-header" (click)="toggleChat()">
    <h3>ğŸ’¬ QA Assistant</h3>
    <div class="server-status" [class.online]="serverAvailable" [class.offline]="!serverAvailable">
      {{ serverAvailable ? 'ğŸŸ¢' : 'ğŸ”´' }}
    </div>
    <button class="toggle-btn" (click)="toggleChat(); $event.stopPropagation()">
      {{ isCollapsed ? 'â†‘' : 'â†“' }}
    </button>
  </div>

    <div class="content-area">
      <app-ranking></app-ranking>
    </div>
  

  <div class="chat-content" *ngIf="!isCollapsed">
    <!-- Mensaje de sistema si el servidor estÃ¡ caÃ­do -->
    <div class="system-alert" *ngIf="!serverAvailable">
      <div class="alert-icon">âš ï¸</div>
      <div class="alert-text">
        <strong>Servidor no disponible</strong>
        <br>
        Verifica que el backend estÃ© ejecutÃ¡ndose en http://localhost:8080
      </div>
    </div>

    <div class="messages-container">
      <div *ngFor="let msg of messages; trackBy: trackByFn" 
           class="message" 
           [class.user-message]="msg.type === 'user'"
           [class.assistant-message]="msg.type === 'assistant'"
           [class.system-message]="msg.type === 'system'"
           [class.error-message]="msg.isError">
        
        <div class="message-avatar">
          <span *ngIf="msg.type === 'user'">ğŸ‘¤</span>
          <span *ngIf="msg.type === 'assistant' && !msg.isError">ğŸ¤–</span>
          <span *ngIf="msg.type === 'assistant' && msg.isError">âŒ</span>
          <span *ngIf="msg.type === 'system'">âš™ï¸</span>
        </div>
        
        <div class="message-content">
          <!-- Mostrar pregunta original -->
          <div class="original-question" *ngIf="msg.response && msg.response.originalQuestion">
            <strong>Pregunta:</strong> {{ msg.response.originalQuestion }}
          </div>

          <!-- Indicador de tipo de respuesta -->
          <div class="intent-badge" 
               *ngIf="msg.response && msg.response.intent !== 'WELCOME'"
               [class.intent-sql]="msg.response.intent === 'SQL'" 
               [class.intent-rag]="msg.response.intent === 'RAG'">
            {{ msg.response.intent === 'SQL' ? 'ğŸ“Š CONSULTA SQL' : 'ğŸ“š BÃšSQUEDA DOCUMENTAL' }}
          </div>

          <!-- Respuesta principal -->
          <div class="message-text" [innerHTML]="msg.text"></div>
          
          <!-- SQL Generado -->
          <div class="sql-section" *ngIf="msg.response && msg.response.generatedSQL">
            <div class="section-title">ğŸ” SQL Generado:</div>
            <code class="sql-code">{{ msg.response.generatedSQL }}</code>
          </div>

          <!-- Resultados en tabla -->
          <div class="results-section" *ngIf="msg.response && msg.response.rawResults && msg.response.rawResults.length > 0">
            <div class="section-title">ğŸ“‹ Resultados ({{ msg.response.rawResults.length }} registros):</div>
            <div class="table-container">
              <table class="results-table">
                <thead>
                  <tr>
                    <th *ngFor="let column of getTableColumns(msg.response.rawResults)">{{ column }}</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let row of msg.response.rawResults; let i = index">
                    <td *ngFor="let column of getTableColumns(msg.response.rawResults)">
                      {{ formatTableCell(row[column]) }}
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Fuentes de informaciÃ³n -->
          <div class="sources-section" *ngIf="msg.response && msg.response.sources && msg.response.sources.length > 0">
            <div class="section-title">ğŸ“š Fuentes consultadas:</div>
            <div class="sources-list">
              <div *ngFor="let source of msg.response.sources; let i = index" class="source-item">
                <div class="source-header">
                  <span class="source-number">#{{ i + 1 }}</span>
                  <span class="source-id">ID: {{ source.id }}</span>
                  <span class="source-score" *ngIf="source.score">Score: {{ source.score | number:'1.2-2' }}</span>
                </div>
                <div class="source-content">{{ source.content }}</div>
              </div>
            </div>
          </div>

          <!-- Estado de la operaciÃ³n -->
          <div class="status-section" 
               *ngIf="msg.response && msg.response.intent !== 'WELCOME'"
               [class.status-success]="msg.response.success" 
               [class.status-error]="!msg.response.success">
            <span class="status-icon">{{ msg.response.success ? 'âœ…' : 'âŒ' }}</span>
            <span class="status-text">
              {{ msg.response.success ? 'Consulta procesada exitosamente' : 'Error en la consulta' }}
            </span>
            <span class="error-message" *ngIf="msg.response.errorMessage">
              {{ msg.response.errorMessage }}
            </span>
          </div>

          <div class="message-time">{{ msg.timestamp | date:'HH:mm' }}</div>

          <!-- Sugerencias -->
          <div class="suggestions" *ngIf="msg.suggestions && msg.suggestions.length > 0">
            <div class="suggestions-label">Sugerencias:</div>
            <div class="suggestions-grid">
              <button *ngFor="let suggestion of msg.suggestions" 
                      class="suggestion-btn-modern"
                      (click)="useSuggestion(suggestion); $event.stopPropagation()"
                      [disabled]="loading">
                {{ suggestion }}
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Loading indicator -->
      <div class="loading-indicator" *ngIf="loading">
        <div class="typing-animation">
          <span></span>
          <span></span>
          <span></span>
        </div>
        <span>Procesando tu consulta...</span>
      </div>
    </div>

    <!-- Input section -->
    <div class="input-section">
      <div class="input-container-modern">
        <input type="text" 
               class="question-input-modern"
               [(ngModel)]="userInput" 
               (keyup.enter)="!loading && sendMessage()"
               placeholder="Escribe tu pregunta sobre QA..."
               [disabled]="loading || !serverAvailable">
        <button class="send-btn-modern" 
                (click)="sendMessage()" 
                [disabled]="loading || !userInput.trim() || !serverAvailable"
                [class.disabled]="!serverAvailable">
          <i class="send-icon" *ngIf="!loading"></i>
          <div class="spinner-modern" *ngIf="loading"></div>
        </button>
      </div>
      
      <div class="action-buttons-modern">
        <button class="action-btn-modern clear-btn" 
                (click)="clearChat()" 
                title="Limpiar chat">
          <i class="action-icon clear-icon"></i>
          Limpiar
        </button>
        <button class="action-btn-modern" 
                (click)="checkServerConnection()" 
                title="Verificar conexiÃ³n">
          <i class="action-icon">ğŸ”</i>
          Verificar ConexiÃ³n
        </button>
      </div>
    </div>

    <footer class="footer">
        <a (click)="showMonitoring()" class="monitoring-link" style="cursor: pointer;">
          ğŸ“Š Sistema de Monitoreo
        </a>
      </footer>
  </div>
</div>

<div *ngIf="showMonitoringView">
  <app-monitoring></app-monitoring>
  <footer class="footer">
    <a (click)="showHome()" class="monitoring-link" style="cursor: pointer;">
      â† Volver a la Home
    </a>
  </footer>
</div>